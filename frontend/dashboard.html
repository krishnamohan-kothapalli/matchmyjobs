<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard — MatchMyJobs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/shared.css">
<style>
.dash-page{max-width:960px;margin:0 auto;padding:2.5rem 1.5rem 4rem}
.page-head{margin-bottom:2rem}
.page-head h1{font-family:var(--font-d);font-size:clamp(1.5rem,3vw,2rem);font-weight:800;color:var(--ink);letter-spacing:-.025em;margin-bottom:.3rem}
.page-head p{font-size:.875rem;color:var(--slate)}

/* STAT CARDS */
.stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--rl);padding:1.4rem 1.6rem;box-shadow:var(--sh)}
.stat-lbl{font-family:var(--font-m);font-size:.68rem;text-transform:uppercase;letter-spacing:.1em;color:var(--mist);margin-bottom:.6rem}
.stat-val{font-family:var(--font-d);font-size:2.2rem;font-weight:800;color:var(--ink);line-height:1;margin-bottom:.25rem}
.stat-val.green{color:var(--green)}
.stat-sub{font-size:.8rem;color:var(--slate)}

/* USAGE CARD */
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--rl);padding:1.6rem;box-shadow:var(--sh);margin-bottom:1.25rem}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.4rem;flex-wrap:wrap;gap:.5rem}
.card-head h2{font-size:1rem;font-weight:700;color:var(--ink)}
.tier-pill{font-family:var(--font-m);font-size:.65rem;font-weight:500;text-transform:uppercase;letter-spacing:.1em;padding:.3rem .9rem;border-radius:999px;background:var(--green-l);color:var(--green-d);border:1px solid rgba(0,200,150,.2)}
.tier-pill.pro{background:#eff6ff;color:#2563eb;border-color:#bfdbfe}

.usage-nums{display:flex;align-items:baseline;gap:.4rem;margin-bottom:.9rem}
.u-used{font-family:var(--font-d);font-size:2.8rem;font-weight:800;color:var(--ink);line-height:1}
.u-sep{font-size:1.6rem;color:var(--border)}
.u-limit{font-family:var(--font-d);font-size:1.75rem;font-weight:700;color:var(--mist);line-height:1}
.u-lbl{font-size:.85rem;color:var(--slate);margin-left:.4rem;align-self:flex-end;padding-bottom:.25rem}

.prog-track{height:10px;background:var(--border);border-radius:999px;overflow:hidden;margin-bottom:.75rem}
.prog-fill{height:100%;border-radius:999px;background:var(--green);transition:width 1s cubic-bezier(.4,0,.2,1)}
.prog-fill.warn{background:var(--amber)}
.prog-fill.full{background:var(--red)}

.usage-foot{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem}
.usage-hint{font-size:.82rem;color:var(--slate)}

/* UPGRADE BANNER */
.upgrade-band{background:linear-gradient(135deg,var(--ink),var(--ink2));border-radius:var(--rl);padding:1.5rem 1.75rem;display:flex;align-items:center;justify-content:space-between;gap:1.25rem;margin-bottom:1.25rem;flex-wrap:wrap}
.upgrade-band h3{font-family:var(--font-d);font-size:1.05rem;font-weight:800;color:#fff;margin-bottom:.25rem}
.upgrade-band p{font-size:.82rem;color:rgba(255,255,255,.45)}
.btn-upgrade{background:var(--green);color:#fff;border:none;border-radius:var(--r);padding:.6rem 1.5rem;font-family:var(--font-b);font-size:.875rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .15s}
.btn-upgrade:hover{background:var(--green-d)}

/* HISTORY TABLE */
.hist-table{width:100%;border-collapse:collapse}
.hist-table th{text-align:left;font-family:var(--font-m);font-size:.65rem;text-transform:uppercase;letter-spacing:.1em;color:var(--mist);padding:.5rem .75rem 1rem;border-bottom:1px solid var(--border)}
.hist-table td{padding:.9rem .75rem;font-size:.875rem;border-bottom:1px solid var(--bg);color:var(--ink)}
.hist-table tr:last-child td{border-bottom:none}
.cur-row td{background:rgba(0,200,150,.04)}
.cur-badge{font-family:var(--font-m);font-size:.6rem;background:var(--green);color:#fff;padding:.15rem .5rem;border-radius:999px;margin-left:.5rem;vertical-align:middle;text-transform:uppercase;letter-spacing:.06em}
.mini-bar{display:flex;align-items:center;gap:.5rem}
.mini-track{height:6px;border-radius:999px;background:var(--border);overflow:hidden;width:80px;flex-shrink:0}
.mini-fill{height:100%;border-radius:999px;background:var(--green)}
.empty-hist{text-align:center;padding:2.5rem;color:var(--slate);font-size:.875rem}

/* ACCOUNT */
.acct-row{display:flex;align-items:center;justify-content:space-between;padding:.85rem 0;border-bottom:1px solid var(--bg);font-size:.875rem}
.acct-row:last-child{border-bottom:none}
.acct-lbl{color:var(--slate);font-weight:500}
.acct-val{font-weight:600;color:var(--ink);font-family:var(--font-m);font-size:.82rem}

/* LOADER */
.skeleton{background:linear-gradient(90deg,var(--border) 25%,var(--bg) 50%,var(--border) 75%);background-size:200% 100%;animation:shimmer 1.2s ease infinite;border-radius:6px}
@keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}

@media(max-width:700px){
  .stat-row{grid-template-columns:1fr 1fr}
  .stat-row .stat-card:last-child{grid-column:span 2}
  .upgrade-band{flex-direction:column;align-items:flex-start}
  .usage-foot{flex-direction:column;align-items:flex-start}
}
@media(max-width:480px){
  .stat-row{grid-template-columns:1fr}
  .stat-row .stat-card:last-child{grid-column:auto}
}
</style>
</head>
<body>
<nav class="nav">
  <div class="nav-in">
    <a href="index.html" class="logo"><span class="logo-a">Match</span><span class="logo-b">MyJobs</span></a>
    <div class="nav-r" id="nav-r"></div>
  </div>
</nav>

<div class="dash-page">
  <div class="page-head reveal">
    <h1 id="greeting">Dashboard</h1>
    <p id="head-sub">Loading your usage data…</p>
  </div>

  <!-- Upgrade banner (shown at limit) -->
  <div class="upgrade-band reveal" id="upgrade-band" style="display:none">
    <div>
      <h3>You've reached your monthly limit</h3>
      <p>Upgrade to Analysis Pro for 50 analyses every month.</p>
    </div>
    <button class="btn-upgrade" onclick="alert('Payment coming soon! Your account will be notified.')">Upgrade — $20 one-time</button>
  </div>

  <!-- Stat cards -->
  <div class="stat-row reveal d1" id="stat-row">
    <div class="stat-card"><div class="stat-lbl">Total Analyses</div><div class="stat-val green" id="s-total">—</div><div class="stat-sub">all time</div></div>
    <div class="stat-card"><div class="stat-lbl">This Month</div><div class="stat-val" id="s-month">—</div><div class="stat-sub" id="s-month-sub">of — used</div></div>
    <div class="stat-card"><div class="stat-lbl">Member Since</div><div class="stat-val" style="font-size:1.2rem;padding-top:.4rem" id="s-since">—</div><div class="stat-sub" id="s-plan">Free Plan</div></div>
  </div>

  <!-- Usage card -->
  <div class="card reveal d2" id="usage-card">
    <div class="card-head">
      <h2>Monthly Usage</h2>
      <span class="tier-pill" id="tier-pill">Free</span>
    </div>
    <div class="usage-nums">
      <span class="u-used" id="u-used">—</span>
      <span class="u-sep">/</span>
      <span class="u-limit" id="u-limit">—</span>
      <span class="u-lbl">analyses this month</span>
    </div>
    <div class="prog-track"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
    <div class="usage-foot">
      <span class="usage-hint" id="usage-hint">Loading…</span>
      <a href="analysis.html" class="btn btn-g" id="analyze-link">
        <svg width="14" height="14" fill="none" viewBox="0 0 20 20"><path d="M10 4v12M4 10h12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>
        New Analysis
      </a>
    </div>
  </div>

  <!-- History -->
  <div class="card reveal d2">
    <div class="card-head"><h2>Usage History</h2></div>
    <div id="hist-wrap"><div class="empty-hist">No history yet. Run your first analysis to get started.</div></div>
  </div>

  <!-- Account details -->
  <div class="card reveal d3">
    <div class="card-head"><h2>Account</h2></div>
    <div class="acct-row"><span class="acct-lbl">Email</span><span class="acct-val" id="a-email">—</span></div>
    <div class="acct-row"><span class="acct-lbl">Name</span><span class="acct-val" id="a-name">—</span></div>
    <div class="acct-row"><span class="acct-lbl">Plan</span><span class="acct-val" id="a-plan">Free (2 analyses/month)</span></div>
    <div class="acct-row"><span class="acct-lbl">Member Since</span><span class="acct-val" id="a-since">—</span></div>
    <div class="acct-row" style="border-bottom:none;padding-top:1.25rem"><span></span><button onclick="signOut()" style="background:transparent;border:1px solid var(--border);border-radius:var(--r);padding:.5rem 1.1rem;font-family:var(--font-b);font-size:.82rem;color:var(--slate);cursor:pointer;transition:all .15s" onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--slate)'">Sign Out</button></div>
  </div>
</div>

<script>
const API = window.location.hostname==='localhost'?'http://127.0.0.1:8000':'https://matchmyjobs.onrender.com';
const email = localStorage.getItem('userEmail');
if(!localStorage.getItem('authToken')){ window.location.href='auth.html'; }

// Nav
document.getElementById('nav-r').innerHTML=`<a href="analysis.html" class="btn-ngg"><svg width="13" height="13" fill="none" viewBox="0 0 20 20"><path d="M10 4v12M4 10h12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>New Analysis</a>`;
function signOut(){ localStorage.clear(); window.location.href='auth.html'; }

async function loadDashboard(){
  try{
    const res = await fetch(`${API}/api/auth/me?email=${encodeURIComponent(email)}`);
    if(res.ok){ render(await res.json()); }
    else { renderFromLocal(); }
  }catch{ renderFromLocal(); }
}

function renderFromLocal(){
  const u=JSON.parse(localStorage.getItem('usageData')||'{}');
  const name=localStorage.getItem('userName')||email?.split('@')[0]||'there';
  render({
    email,name,tier:u.userTier||'free',member_since:'Recently',
    current_month:{analyses_used:u.analysesUsed||0,analyses_limit:u.analysesLimit||2,remaining:Math.max(0,(u.analysesLimit||2)-(u.analysesUsed||0)),can_analyze:(u.analysesUsed||0)<(u.analysesLimit||2),month:new Date().toLocaleString('default',{month:'long',year:'numeric'})},
    usage_history:[],stats:{total_analyses:u.analysesUsed||0,months_active:1}
  });
}

function render(d){
  const cm=d.current_month, pct=Math.min(100,Math.round(cm.analyses_used/cm.analyses_limit*100));
  const firstName=d.name?.split(' ')[0]||'there';
  document.getElementById('greeting').textContent=`Welcome back, ${firstName}!`;
  document.getElementById('head-sub').textContent=`Here's your usage for ${cm.month}`;

  // Stats
  document.getElementById('s-total').textContent=d.stats?.total_analyses??0;
  document.getElementById('s-month').textContent=cm.analyses_used;
  document.getElementById('s-month-sub').textContent=`of ${cm.analyses_limit} used`;
  document.getElementById('s-since').textContent=d.member_since||'—';
  document.getElementById('s-plan').textContent=formatPlan(d.tier);

  // Usage card
  document.getElementById('u-used').textContent=cm.analyses_used;
  document.getElementById('u-limit').textContent=cm.analyses_limit;
  const fill=document.getElementById('prog-fill');
  fill.style.width=pct+'%';
  fill.className='prog-fill'+(pct>=100?' full':pct>=80?' warn':'');
  const pill=document.getElementById('tier-pill');
  pill.textContent=formatTier(d.tier);
  if(d.tier!=='free') pill.classList.add('pro');

  if(!cm.can_analyze){
    document.getElementById('usage-hint').textContent='Limit reached — resets on the 1st of next month.';
    document.getElementById('analyze-link').style.opacity='.4';
    document.getElementById('analyze-link').style.pointerEvents='none';
    document.getElementById('upgrade-band').style.display='flex';
  } else {
    document.getElementById('usage-hint').textContent=cm.remaining===1?'1 analysis remaining this month':`${cm.remaining} analyses remaining this month`;
  }

  // Account
  document.getElementById('a-email').textContent=d.email;
  document.getElementById('a-name').textContent=d.name||'—';
  document.getElementById('a-plan').textContent=formatPlanFull(d.tier);
  document.getElementById('a-since').textContent=d.member_since||'—';

  // History
  const hist=d.usage_history||[];
  if(hist.length===0){ return; }
  const thisMonth=new Date().toISOString().slice(0,7);
  const maxA=Math.max(...hist.map(h=>h.analyses),1);
  document.getElementById('hist-wrap').innerHTML=`
    <table class="hist-table">
      <thead><tr><th>Month</th><th>Analyses</th><th>Optimizations</th></tr></thead>
      <tbody>${hist.map(h=>`
        <tr class="${h.month===thisMonth?'cur-row':''}">
          <td>${fmtMonth(h.month)}${h.month===thisMonth?'<span class="cur-badge">Current</span>':''}</td>
          <td><div class="mini-bar"><div class="mini-track"><div class="mini-fill" style="width:${Math.round(h.analyses/maxA*100)}%"></div></div><span>${h.analyses}</span></div></td>
          <td>${h.optimizations||0}</td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

function formatTier(t){ return{free:'Free',analysis_pro:'Pro',optimize:'Optimize'}[t]||'Free'; }
function formatPlan(t){ return{free:'Free Plan',analysis_pro:'Analysis Pro',optimize:'Optimize Plan'}[t]||'Free Plan'; }
function formatPlanFull(t){ return{free:'Free (2 analyses/month)',analysis_pro:'Analysis Pro (50 analyses/month)',optimize:'Optimize (50 analyses + 25 rewrites/month)'}[t]||'Free (2 analyses/month)'; }
function fmtMonth(s){ const [y,m]=s.split('-'); return new Date(+y,+m-1,1).toLocaleString('default',{month:'long',year:'numeric'}); }

const io=new IntersectionObserver(e=>e.forEach(en=>{if(en.isIntersecting){en.target.classList.add('in');io.unobserve(en.target);}}),{threshold:.1});
document.querySelectorAll('.reveal').forEach(el=>io.observe(el));
loadDashboard();
</script>
</body>
</html>
